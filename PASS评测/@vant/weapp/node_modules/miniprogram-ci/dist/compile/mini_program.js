"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compile=void 0;const cache_1=require("../utils/cache"),common_1=require("./common"),mpjson_1=require("./handler/mpjson"),white_ext_list_1=require("../utils/white_ext_list"),config_1=require("../config"),common_2=require("../utils/common"),path=require("path"),getProjectConfig=require("../json/projectconfig"),locales=require("../utils/locales/locales"),uglifyfilenames_1=require("../utils/uglifyfilenames");async function compile(i,e){var o;cache_1.cacheManager.clean();const t=await getProjectConfig(i,!1),a=t.miniprogramRoot||"";(await i.attr()).gameApp&&common_2.throwError({filePath:"",msg:locales.config.PROJECT_TYPE_ERROR.format(i.appid,locales.config.MINI_GAME),code:config_1.PROJECT_TYPE_ERROR});const{MiniProgramWhiteList:r}=await white_ext_list_1.getWhiteExtList(),n=i.getFileList(a,"").filter(common_1.isNotIgnoredByProjectConfig.bind(null,t,a)).filter(i=>r.has(path.posix.extname(i))),s=await mpjson_1.compileJSON(i,e),m=n.filter(i=>".js"===path.posix.extname(i)).map(i=>path.posix.relative(a,i)),c=await common_1.compileJSFiles(i,m,a,e),l=n.filter(i=>".wxss"===path.posix.extname(i)).map(i=>path.posix.relative(a,i)),p=await common_1.compileWXSSFiles(i,l,a,e),_=n.filter(i=>".wxml"===path.posix.extname(i)).map(i=>path.posix.relative(a,i)),g=await common_1.compileWXMLFiles(i,_,a,e),f=n.filter(i=>{const e=path.posix.extname(i);return".js"!==e&&".json"!==e&&".wxss"!==e&&".wxml"!==e}),u=await common_1.compileOther(i,f,e);let h=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},s),c),u),p),g);if(i.type===config_1.COMPILE_TYPE.miniProgram){if(t.miniprogramRoot&&"."!==t.miniprogramRoot&&"./"!==t.miniprogramRoot){const e={};for(const o in h)e[path.posix.relative(i.miniprogramRoot,o)]=h[o];h=e}h["project.config.json"]=JSON.stringify({miniprogramRoot:"",__compileDebugInfo__:e.__compileDebugInfo__||{}})}else h["project.config.json"]=JSON.stringify({miniprogramRoot:i.miniprogramRoot||"",__compileDebugInfo__:e.__compileDebugInfo__||{}});return i.type===config_1.COMPILE_TYPE.miniProgram&&(null===(o=e.setting)||void 0===o?void 0:o.codeProtect)&&(h=await uglifyfilenames_1.uglifyFileNames(i,h)),h}exports.compile=compile;