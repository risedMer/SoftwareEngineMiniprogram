"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compile=void 0;const path=require("path"),getGameJSON=require("../json/game"),getProjectConfig=require("../json/projectconfig"),common_1=require("./common"),taskstatus_1=require("../utils/taskstatus"),config_1=require("../config"),common_2=require("../utils/common"),locales=require("../utils/locales/locales"),cache_1=require("../utils/cache"),white_ext_list_1=require("../utils/white_ext_list"),lodash_1=require("lodash"),uglifyfilenames_1=require("../utils/uglifyfilenames");async function compileGameJSON(e,t){const{onProgressUpdate:o=(()=>{})}=t,i=new taskstatus_1.TaskStatus("game.json");o(i);const a=await getGameJSON(e,!1);return i.done(),o(i),a}function getSpecialPackagePaths(e){const t=[];return e.openDataContext&&t.push(e.openDataContext),e.workers&&t.push(e.workers),e.subPackages&&e.subPackages.forEach(e=>{if(e.independent){const o=e.root.replace(/^\//,"");!/\.js$/.test(o)&&t.push(o)}}),t.forEach((e,o)=>{e.endsWith("/")||(t[o]=e+"/")}),t}async function compile(e,t){var o;cache_1.cacheManager.clean();const i=await getProjectConfig(e,!1);!1===(await e.attr()).gameApp&&common_2.throwError({filePath:"",msg:locales.config.PROJECT_TYPE_ERROR.format(e.appid,locales.config.MINI_PROGRAM),code:config_1.PROJECT_TYPE_ERROR});const a=i.miniprogramRoot||"",{GameWhiteList:s}=await white_ext_list_1.getWhiteExtList(),n=e.getFileList(a,"").filter(common_1.isNotIgnoredByProjectConfig.bind(null,i,a)).filter(e=>s.has(path.posix.extname(e))),r=await compileGameJSON(e,t);e.stat(a,"game.js")||common_2.throwError({msg:locales.config.FILE_NOT_FOUND.format(path.posix.join(a,"game.js")),filePath:path.posix.join(a,"game.js"),code:config_1.FILE_NOT_FOUND});const c=n.filter(e=>".js"===path.posix.extname(e)).map(e=>path.posix.relative(a,e)),m=getSpecialPackagePaths(r);let l=[...c];for(const e of m){const t=c.filter(t=>t.startsWith(e));l=lodash_1.xorWith(c,t)}let g=await common_1.compileJSFiles(e,l,a,t),p="@babel/runtime";t.setting&&t.setting.es7&&(p=await common_1.getBabelRoot(e));for(const o of m){let i=c.filter(e=>e.startsWith(o));i=i.map(e=>e.replace(new RegExp("^"+o),""));const s=await common_1.compileJSFiles(e,i,path.posix.join(a,o),t);g=Object.assign(Object.assign({},g),s)}const _=n.filter(e=>e!==path.posix.join(a,"game.json")&&".js"!==path.posix.extname(e)),f=await common_1.compileOther(e,_,t),u=await common_1.getUploadProjectConfig(e,i);let h=Object.assign(Object.assign({},g),f);if(e.type===config_1.COMPILE_TYPE.miniGame){if(u.miniprogramRoot&&"."!==u.miniprogramRoot&&"./"!==u.miniprogramRoot){const t={};for(const o in h)t[path.posix.relative(e.miniprogramRoot,o)]=h[o];h=t}u.miniprogramRoot="",h["game.json"]=JSON.stringify(r)}else h[path.posix.join(u.miniprogramRoot||"","game.json")]=JSON.stringify(r);return u.__compileDebugInfo__=t.__compileDebugInfo__||{},h["project.config.json"]=JSON.stringify(u),e.type===config_1.COMPILE_TYPE.miniGame&&(null===(o=t.setting)||void 0===o?void 0:o.codeProtect)&&(h=await uglifyfilenames_1.uglifyFileNames(e,h)),h}exports.compile=compile;