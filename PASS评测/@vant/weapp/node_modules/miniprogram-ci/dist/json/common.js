"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.transValidateResult=exports.getPageJSONVariableDecalearProperty=exports.checkComponentPath=exports.getUseExtendLib=exports.checkPagePathIsInIndependentSubpackage=exports.checkPagePathIsInSubPackage=exports.checkJSONFormat=void 0;const tools_1=require("../utils/tools"),config_1=require("../config"),path=require("path"),locales=require("../utils/locales/locales"),common_1=require("../utils/common"),config_2=require("../config"),lodash_1=require("lodash"),config_3=require("../config");function checkJSONFormat(e,t){let o={};e||common_1.throwError({filePath:t,msg:"Empty file is NOT a valid json file",code:config_1.JSON_PARSE_ERR});try{o=JSON.parse(e)}catch(o){const n=tools_1.formatJSONParseErr({filePath:t,data:e,error:o});common_1.throwError({filePath:t,msg:n,code:config_1.JSON_PARSE_ERR})}return o}function checkPagePathIsInSubPackage(e,t){const{subPackages:o}=e;if(o)for(const e of o)if(0===t.indexOf(e.root))return e}function checkPagePathIsInIndependentSubpackage(e,t){const o=checkPagePathIsInSubPackage(e,t);if(o&&!0===o.independent)return o}function checkNodeModulesFile(e,t,o,n){let r=path.posix.join(o,"index")+".json",i=e.stat(t,r);return i&&i.isFile?r:(r=path.posix.join(o,n)+".json",i=e.stat(t,r),i&&i.isFile?r:(r=o+".json",i=e.stat(t,r),i&&i.isFile?r:""))}function resolveComponentPath(e,t,o,n){n=tools_1.normalizePath(n);let r=path.posix.join(o,n)+".json";const i=e.stat(t,r);if(i&&i.isFile)return n;let a=o.split(path.posix.sep);for(a=a.filter(e=>!!e),r="";a.length;){if(r=checkNodeModulesFile(e,t,path.posix.join(a.join(path.posix.sep),"miniprogram_npm",n),n),r)break;a.pop()}if(!r){r=checkNodeModulesFile(e,t,path.posix.join("miniprogram_npm",n),n)}return r&&(/\.json$/.test(r)&&(r=r.substring(0,r.length-5)),r=path.posix.relative(o,r)),r}exports.checkJSONFormat=checkJSONFormat,exports.checkPagePathIsInSubPackage=checkPagePathIsInSubPackage,exports.checkPagePathIsInIndependentSubpackage=checkPagePathIsInIndependentSubpackage;const _checkComponentPath=async e=>{const{value:t,tips:o,project:n,root:r,relativePath:i}=e,a=path.posix.join(r,i);if(t.startsWith("plugin://")||t.startsWith("plugin-private://"))return t;const s=await getUseExtendLib(n,i);if(t.startsWith("/")){if(s.length){const e=s.map(e=>"/miniprogram_npm/"+e);let o=!1;for(const n of e)if(t.startsWith(n)){o=!0;break}if(o)return t}if(n.stat(r,t+".json"))return t;if(n.stat(r,t+"/index.json"))return t+"/index";common_1.throwError({msg:locales.config.NOT_FOUND.format(o),filePath:a})}if(t.startsWith(".")){if(t.startsWith("../")){const e=t.replace(/^(\.\.\/)+/,"");if(n.stat(r,path.posix.join(`/${e}.json`)))return t;if(n.stat(r,path.posix.join(`/${e}/index.json`)))return t+"/index"}if(n.stat(r,path.posix.join(path.posix.dirname(i),t+".json")))return t;if(n.stat(r,path.posix.join(path.posix.dirname(i),t+"/index.json")))return t+"/index";common_1.throwError({msg:locales.config.NOT_FOUND.format(`${o}: "${t}"`),filePath:a})}for(const e of s)if(t.startsWith(e))return"miniprogram-element"===e?`/miniprogram_npm/${e}/index`:t.replace(e,"/miniprogram_npm/"+e);const c=resolveComponentPath(n,r,path.posix.dirname(i),t);return c||common_1.throwError({msg:locales.config.NOT_FOUND.format(`${o}: "${t}"`),filePath:a}),c.startsWith(".")?c:"./"+c};async function getUseExtendLib(e,t){var o;const n=await e.getFile("","project.config.json"),r=checkJSONFormat(common_1.checkUTF8(n,"project.config.json"),"project.config.json").miniprogramRoot||"",i=tools_1.normalizePath(path.posix.join(r,"app.json"));e.stat(r,"app.json")||common_1.throwError({msg:locales.config.NOT_FOUND.format(i),filePath:i});const a=await e.getFile(r,"app.json"),s=checkJSONFormat(common_1.checkUTF8(a,i),i);let c=[];if("[object Object]"===Object.prototype.toString.call(s.useExtendedLib)){const e=Object.keys(config_2.extendedLibMap),t=Object.keys(s.useExtendedLib).filter(t=>!e.includes(t));t.length&&common_1.throwError({msg:t.join(", ")+' is not allowed in ["useExtendedLib"]',filePath:"app.json"}),c=Object.keys(s.useExtendedLib||{}).filter(e=>s.useExtendedLib[e]).map(e=>config_2.extendedLibMap[e].packages),c=lodash_1.flattenDeep(c)}const p=checkPagePathIsInSubPackage(s,t);if(p&&p.useExtendedLib&&"[object Object]"===Object.prototype.toString.call(p.useExtendedLib)){const e=Object.keys(config_2.extendedLibMap),t=Object.keys(p.useExtendedLib).filter(t=>!e.includes(t));t.length&&common_1.throwError({msg:`${t.join(", ")} is not allowed in subPackages[${null===(o=s.subPackages)||void 0===o?void 0:o.indexOf(p)}]["useExtendedLib"]`,filePath:"app.json"});const n=Object.keys(p.useExtendedLib||{}).filter(e=>p.useExtendedLib[e]).map(e=>config_2.extendedLibMap[e].packages);c=lodash_1.uniq(c.concat(lodash_1.flattenDeep(n)))}return c}function getPageJSONVariableDecalearProperty(e){const{windowPropertWhiteList:t}=config_3.jsonVariablePropertyWhiteList;let o=[];return"[object Object]"===Object.prototype.toString.call(e)&&(o=o.concat(Object.keys(e).filter(e=>t.includes(e)).map(t=>({property:`["${t}"]`,value:e[t]})).filter(e=>e.value.startsWith("@")))),o}function transValidateResult(e){return e.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])).join("\n")}exports.getUseExtendLib=getUseExtendLib,exports.checkComponentPath=async e=>{const{project:t,root:o,relativePath:n,inputJSON:r}=e,{usingComponents:i,componentGenerics:a}=r;if(i)for(const e in i){const r=i[e]||"";i[e]=await _checkComponentPath({tips:`["usingComponents"]["${e}"]`,value:r,project:t,root:o,relativePath:n})}if(a)for(const e in a){const r="object"==typeof a[e],i=r?a[e].default:a[e];if(!i||"string"!=typeof i)continue;const s=await _checkComponentPath({tips:`["componentGenerics"]["${e}"]`,value:i,project:t,root:o,relativePath:n});r?a[e].default=s:a[e]=s}},exports.getPageJSONVariableDecalearProperty=getPageJSONVariableDecalearProperty,exports.transValidateResult=transValidateResult;