"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mergeThemeJSONToPageJSON=exports.mergeThemeJSONToAppJSON=exports.checkThemeJSON=exports.getPluginThemeLocation=exports.getThemeLocation=void 0;const path=require("path"),lodash_1=require("lodash"),tools_1=require("../utils/tools"),getProjectConfig=require("./projectconfig"),locales=require("../utils/locales/locales"),common_1=require("../utils/common"),common_2=require("./common"),cache_1=require("../utils/cache"),app_1=require("./app/app"),{schemaValidate:schemaValidate}=require("../validate/schemaValidate"),_=require("lodash"),config_1=require("../config"),plugin_1=require("../json/plugin/plugin");async function getThemeLocation(e){const o=(await app_1.getAppJSON(e,!1,!0)).themeLocation;return"[object Undefined]"!==Object.prototype.toString.call(o)?"string"==typeof o?(common_1.checkPath({value:o,tips:'["themeLocation"]',filePath:"app.json"}),o):(common_1.throwError({msg:locales.config.JSON_CONTENT_SHOULD_BE.format('appJSON["themeLocation"]',"string"),filePath:"app.json"}),null):null}async function getPluginThemeLocation(e){return(await plugin_1.getDevPluginJSON(e)).themeLocation||null}async function checkThemeJSON(e,o,t=!0){const{themeLocation:r,isPlugin:i}=o;let a=cache_1.cacheManager.get(e,cache_1.CACHE_KEY.THEME_JSON);if(a&&t)return lodash_1.cloneDeep(a);const c=await getProjectConfig(e),n=i?c.pluginRoot:c.miniprogramRoot,s=tools_1.normalizePath(path.posix.join(n||"",r));e.stat("",s)||common_1.throwError({msg:locales.config.FILE_NOT_FOUND.format(s),filePath:"app.json"});const l=await e.getFile("",s),h=common_1.checkUTF8(l,s);a=common_2.checkJSONFormat(h,s);const p=schemaValidate("theme",a);if(p.error.length){const e=p.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])).join("\n");common_1.throwError({msg:e,filePath:s})}return lodash_1.cloneDeep(a)}function mergeThemeJSONToAppJSON(e,o){const{windowPropertWhiteList:t,tabBarPropertyWhiteList:r,tabbarListItemPropertyWhiteList:i}=config_1.jsonVariablePropertyWhiteList,a=/^@/,c=_.cloneDeep(o.window||{}),n=_.cloneDeep(o.window||{});Object.keys(c).forEach(o=>{const r=c[o];if(a.test(r)){t.includes(o)||common_1.throwError({msg:""+locales.config.SHOULD_NOT_IN.format([r,o]),filePath:"app.json"});const i=r.slice(1);c[o]=e.light[i]||r,n[o]=e.dark[i]||r}});const s=lodash_1.cloneDeep(o),l=lodash_1.cloneDeep(o);if(s.window=c,l.window=n,o.tabBar&&o.tabBar.list&&o.tabBar.list.length){const t=_.cloneDeep(o.tabBar||{list:[]}),c=_.cloneDeep(o.tabBar||{list:[]});t.list&&t.list.length>0&&Object.keys(t).forEach(o=>{if("list"!==o){const i=t[o];if(a.test(i)){r.includes(o)||common_1.throwError({msg:""+locales.config.SHOULD_NOT_IN.format([i,o]),filePath:"app.json"});const a=i.slice(1);t[o]=e.light[a]||i,c[o]=e.dark[a]||i}}else t.list.forEach((o,r)=>{Object.keys(o).forEach(n=>{const s=o[n];if(a.test(s)){i.includes(n)||common_1.throwError({msg:""+locales.config.SHOULD_NOT_IN.format([s,n]),filePath:"app.json"});const o=s.slice(1);t.list[r][n]=e.light[o]||s,c.list[r][n]=e.dark[o]||s}})})}),l.tabBar=c,s.tabBar=t}return{appJSONLight:s,appJSONDark:l}}function mergeThemeJSONToPageJSON(e,o,t){const r=config_1.jsonVariablePropertyWhiteList.windowPropertWhiteList,i=_.cloneDeep(o||{}),a=_.cloneDeep(o||{}),c=/^@/;return Object.keys(o).forEach(n=>{const s=o[n];if(c.test(s)){const o=s.slice(1);r.includes(n)||common_1.throwError({msg:""+locales.config.SHOULD_NOT_IN.format([s,n]),filePath:t}),a[n]=e.light[o]||s,i[n]=e.dark[o]||s}}),{pageJSONDark:i,pageJSONLight:a}}exports.getThemeLocation=getThemeLocation,exports.getPluginThemeLocation=getPluginThemeLocation,exports.checkThemeJSON=checkThemeJSON,exports.mergeThemeJSONToAppJSON=mergeThemeJSONToAppJSON,exports.mergeThemeJSONToPageJSON=mergeThemeJSONToPageJSON;