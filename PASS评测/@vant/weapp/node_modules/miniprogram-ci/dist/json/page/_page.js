"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkPageJSON=void 0;const path=require("path"),lodash_1=require("lodash"),locales=require("../../utils/locales/locales"),common_1=require("../common"),{schemaValidate:schemaValidate,NEW_CHECK_JSON_WAY:NEW_CHECK_JSON_WAY}=require("../../validate/schemaValidate"),tools_1=require("../../utils/tools"),cache_1=require("../../utils/cache"),common_2=require("../../utils/common"),theme_1=require("../theme"),checkHexColor=e=>{const{inputJSON:o,mode:a,pagePath:t,themeLocation:r}=e;let c=t+".json";if(o){r&&(c=`${t}.json or ${r}["${a}"]`);const{navigationBarBackgroundColor:e,backgroundColor:n}=o;void 0===e||tools_1.isHexColor(e)||common_2.throwError({msg:`["navigationBarBackgroundColor"]: "${e}" is not hexColor`,filePath:c}),void 0===n||tools_1.isHexColor(n)||common_2.throwError({msg:`["backgroundColor"]: "${n}" is not hexColor`,filePath:c})}};async function _checkPageJSON(e){const{project:o,pagePath:a}=e;let t=e.filePath;if(!o.stat("",t))return{};const r=await o.getFile("",t),c=common_1.checkJSONFormat(common_2.checkUTF8(r,t),t),n=await theme_1.getThemeLocation(o);if(!n){const e=common_1.getPageJSONVariableDecalearProperty(c);e.length&&common_2.throwError({msg:'["themeLocation"] is required because:\n'+e.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}`).join("\n"),filePath:t})}let i={light:{},dark:{}};n&&(i=await theme_1.checkThemeJSON(o,{themeLocation:n}));const l=theme_1.mergeThemeJSONToPageJSON(i,c,t),h=schemaValidate("page",l.pageJSONLight),m=schemaValidate("page",l.pageJSONDark),s=common_1.getPageJSONVariableDecalearProperty(l.pageJSONLight);s.length&&common_2.throwError({msg:s.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}, but not found at ${n}["light"]`).join("\n"),filePath:t});const g=common_1.getPageJSONVariableDecalearProperty(l.pageJSONDark);if(g.length&&common_2.throwError({msg:g.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}, but not found at ${n}["dark"]`).join("\n"),filePath:t}),h.warning&&(c.__warning__=locales.config.INVALID.format(h.warning)),n&&m.warning&&(c.__warning__=locales.config.INVALID.format(m.warning)),h.error.length){const e=common_1.transValidateResult(h);n&&(t+=` or ${n}["light"]`),common_2.throwError({msg:e,filePath:t})}if(n&&m.error.length){const e=common_1.transValidateResult(m);n&&(t+=` or ${n}["dark"]`),common_2.throwError({msg:e,filePath:t})}return checkHexColor({inputJSON:l.pageJSONLight,mode:"light",themeLocation:n||"",filePath:t,pagePath:a}),checkHexColor({inputJSON:l.pageJSONDark,mode:"dark",themeLocation:n||"",filePath:t,pagePath:a}),c}async function checkPageJSON(e,o){const{pagePath:a,miniprogramRoot:t="",useCache:r=!0}=o,c=tools_1.normalizePath(path.posix.join(t,a+".json")),n=`${cache_1.CACHE_KEY.PAGE_JSON}_${c}`,i=cache_1.cacheManager.get(e,n);if(i&&r)return lodash_1.cloneDeep(i);const l=await _checkPageJSON({project:e,miniprogramRoot:t,pagePath:a,filePath:c});return cache_1.cacheManager.set(e,n,i),lodash_1.cloneDeep(l)}exports.checkPageJSON=checkPageJSON;