"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAppJSON=exports.checkAppJSON=void 0;const path=require("path"),locales=require("../../utils/locales/locales"),getProjectConfigJSON=require("../projectconfig"),common_1=require("../../utils/common"),config_1=require("../../config"),common_2=require("../common"),cache_1=require("../../utils/cache"),lodash_1=require("lodash"),{schemaValidate:schemaValidate}=require("../../validate/schemaValidate"),_app_1=require("./_app"),tools_1=require("../../utils/tools"),theme_1=require("../theme");function transValidateResult(e){return e.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])).join("\n")}async function checkAppJSON(e){const{inputJSON:a}=e;let t=e.filePath;const r=await theme_1.getThemeLocation(e.project);if(!r){const e=_app_1.getAppJSONVariableDecalearProperty(a);e.length&&common_1.throwError({msg:'appJSON["themeLocation"] is required because:\n'+e.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}`).join("\n"),filePath:t})}let o={light:{},dark:{}};r&&(o=await theme_1.checkThemeJSON(e.project,{themeLocation:r}));const c=theme_1.mergeThemeJSONToAppJSON(o,a),p=_app_1.getAppJSONVariableDecalearProperty(c.appJSONLight);p.length&&common_1.throwError({msg:p.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}, but not found at ${r}["light"]`).join("\n"),filePath:t});const n=_app_1.getAppJSONVariableDecalearProperty(c.appJSONDark);n.length&&common_1.throwError({msg:n.map(e=>`"${e.value}" as variable was declared at ${t}:${e.property}, but not found at ${r}["dark"]`).join("\n"),filePath:t});const i=schemaValidate("app",c.appJSONLight),_=schemaValidate("app",c.appJSONDark);if(i.warning&&(a.__warning__=locales.config.INVALID.format(i.warning)),r&&_.warning&&(a.__warning__=locales.config.INVALID.format(_.warning)),i.error.length){const e=transValidateResult(i);r&&(t+=` or ${r}["light"]`),common_1.throwError({msg:e,filePath:t})}if(r&&_.error.length){const e=transValidateResult(_);r&&(t+=` or ${r}["dark"]`),common_1.throwError({msg:e,filePath:t})}const s=Object.assign(Object.assign({},e),{mode:"light",inputJSON:c.appJSONLight}),l=Object.assign(Object.assign({},e),{mode:"dark",inputJSON:c.appJSONDark});_app_1.checkMainPkgPages(e),await _app_1.checkSubpackages(e),await _app_1.checkTabbar(s),r&&await _app_1.checkTabbar(l),_app_1.checkWorkers(e),_app_1.checkFunctionalPages(e),_app_1.checkOpenLocationPagePath(e),await _app_1.checkSitemapLocation(e),_app_1.checkPlugins(e),_app_1.checkWindow(s),r&&_app_1.checkWindow(l),await _app_1.checkComponentPath(e);const h=common_1.getAllPagesInfo(a);return _app_1.checkEntryPagePath(e,h),_app_1.checkPreloadRule(e,h),_app_1.checkTabbarPage(e),_app_1.checkMainPkgPageIsInSubpkg(e),_app_1.checkMainPkgPluginIsInSubPkg(e),_app_1.checkEntranceDeclare(e),a}async function getAppJSON(e,a=!0,t=!1){let r=cache_1.cacheManager.get(e,cache_1.CACHE_KEY.APP_JSON);if(r&&a)return lodash_1.cloneDeep(r);const o=await getProjectConfigJSON(e,a),{miniprogramRoot:c=""}=o,p=tools_1.normalizePath(path.posix.join(c,"app.json"));e.stat(c,"app.json")||common_1.throwError({msg:locales.config.NOT_FOUND.format(p),code:config_1.FILE_NOT_FOUND,filePath:p});const n=await e.getFile(c,"app.json");return r=common_2.checkJSONFormat(common_1.checkUTF8(n,p),p),t||(await checkAppJSON({project:e,miniprogramRoot:c,filePath:p,inputJSON:r}),cache_1.cacheManager.set(e,cache_1.CACHE_KEY.APP_JSON,r)),lodash_1.cloneDeep(r)}exports.checkAppJSON=checkAppJSON,exports.getAppJSON=getAppJSON;