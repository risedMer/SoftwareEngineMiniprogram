"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getExtJSON=void 0;const cache_1=require("../../utils/cache"),common_1=require("../common"),common_2=require("../../utils/common"),lodash_1=require("lodash"),tools_1=require("../../utils/tools"),path=require("path"),getProjectConfigJSON=require("../projectconfig"),locales=require("../../utils/locales/locales"),{schemaValidate:schemaValidate}=require("../../validate/schemaValidate"),theme_1=require("../theme"),_app_1=require("./_app");async function checkExtPages(e){const{project:o,inputJSON:a,filePath:r,miniprogramRoot:t}=e,{extPages:c}=a;if(c)for(const e in c){const a=c[e];if(a){a.navigationBarBackgroundColor&&!tools_1.isHexColor(a.navigationBarBackgroundColor)&&common_2.throwError({msg:`["extPages"]["${e}"]["navigationBarBackgroundColor"]: "${a.navigationBarBackgroundColor}" is not hexColor`,filePath:r}),a.backgroundColor&&!tools_1.isHexColor(a.backgroundColor)&&common_2.throwError({msg:`["extPages"]["${e}"]["backgroundColor"]: "${a.backgroundColor}" is not hexColor`,filePath:r});try{await _app_1.checkComponentPath({project:o,miniprogramRoot:t,inputJSON:a,filePath:e+".json"})}catch(o){common_2.throwError({msg:`["extPages"]["${e}"]${o.message}`,filePath:r})}}}}async function getExtJSON(e,o=!0){const a=await getProjectConfigJSON(e,o),{miniprogramRoot:r=""}=a,t=await e.attr(),c=tools_1.normalizePath(path.posix.join(r,"ext.json"));if(!t||!t.platform)return e.stat(r,"ext.json")?{__warning__:locales.config.EXT_JSON_INVALID.format(e.appid,"https://developers.weixin.qq.com/miniprogram/dev/devtools/ext.html")}:void 0;const n=cache_1.cacheManager.get(e,cache_1.CACHE_KEY.EXT_JSON);if(n&&o)return lodash_1.cloneDeep(n);if(!e.stat(r,"ext.json"))return;const i=await e.getFile(r,"ext.json"),_=common_1.checkJSONFormat(common_2.checkUTF8(i,c),c);if(!_.extEnable)return cache_1.cacheManager.set(e,cache_1.CACHE_KEY.EXT_JSON,{}),{};const p=await theme_1.getThemeLocation(e);let s={};p&&(s=await theme_1.checkThemeJSON(e,{themeLocation:p}));const l=theme_1.mergeThemeJSONToAppJSON(s,_),h=schemaValidate("ext",l.appJSONLight),m=schemaValidate("ext",l.appJSONDark);if(h.warning&&(_.__warning__=locales.config.INVALID.format(h.warning)),m.warning&&(_.__warning__=locales.config.INVALID.format(m.warning)),h.error.length||m.error.length){const e=h.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])),o=m.error.map(e=>"type"===e.errorType||"enum"===e.errorType||"anyOf"===e.errorType?locales.config.JSON_CONTENT_SHOULD_BE.format([e.errorProperty,e.correctType]):locales.config.SHOULD_NOT_BE_EMPTY.format([e.requireProperty])),a=e.concat(o).join("\n");common_2.throwError({msg:a,filePath:c})}_.extAppid||common_2.throwError({msg:""+locales.config.EXT_APPID_SHOULD_NOT_BE_EMPTY,filePath:c});const g={filePath:c,project:e,miniprogramRoot:r,inputJSON:_},u=lodash_1.cloneDeep(g);u.inputJSON=l.appJSONLight,u.mode="light";const f=lodash_1.cloneDeep(g);return f.inputJSON=l.appJSONDark,f.mode="dark",_app_1.checkMainPkgPages(g),_app_1.checkMainPkgPages(g),await _app_1.checkSubpackages(g),await _app_1.checkTabbar(u),await _app_1.checkTabbar(f),_app_1.checkWorkers(g),_app_1.checkFunctionalPages(g),_app_1.checkOpenLocationPagePath(g),_app_1.checkSitemapLocation(g),_app_1.checkPlugins(g),_app_1.checkWindow(u),_app_1.checkWindow(f),await _app_1.checkComponentPath(g),await checkExtPages(g),cache_1.cacheManager.set(e,cache_1.CACHE_KEY.EXT_JSON,_),lodash_1.cloneDeep(_)}exports.getExtJSON=getExtJSON;